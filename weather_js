window.addEventListener("DOMContentLoaded", () => {
  let userName = prompt("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

  if (userName) {
    document.getElementById("title").textContent = `ğŸŒ¤ ${userName}ë‹˜ ë§Œì˜ ë‚ ì”¨`;
  }
});

// ---------------------------
// âŒ ê¸°ì¡´ OpenWeather API Key ì œê±°
// ---------------------------
// const API_KEY = "c930f6cdaa430f04e573bc843634c9b8";

// âœ” Netlifyì— ë³´ê´€ëœ í‚¤ ì‚¬ìš©
//    í˜¸ì¶œ URL: /.netlify/functions/weather?city=Seoul

// ğŸŸ¢ Unsplash KeyëŠ” ê³µê°œì—¬ë„ OK
const UNSPLASH_ACCESS_KEY = "ePwYJpCLjr2DthQcaTKekXetE38KPbOGEEoVVrdX9Hs";


// --- Unsplash ë„ì‹œ ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ---
async function fetchCityImage(city) {
  const url = `https://api.unsplash.com/search/photos?query=${city}&client_id=${UNSPLASH_ACCESS_KEY}&orientation=landscape`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (data.results.length === 0) {
      console.log("ë„ì‹œì— ëŒ€í•œ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const imageUrl = data.results[0].urls.regular;

    document.body.style.backgroundImage = `url(${imageUrl})`;
    document.body.style.backgroundSize = "cover";
    document.body.style.backgroundPosition = "center";
    document.body.style.backgroundRepeat = "no-repeat";

  } catch (error) {
    console.error("ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", error);
  }
}


// ---------------------------
// â­ í˜„ì¬ ë‚ ì”¨ (Netlify Function ë²„ì „)
// ---------------------------
async function fetchWeather(city) {
  const url = `/.netlify/functions/weather?city=${city}`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (data.cod == "404") {
      alert("ë„ì‹œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ ë„ì‹œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    displayWeather(data);

    const temp = data.main.temp;
    updateWeatherimage(temp);

    // ë„ì‹œ ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
    fetchCityImage(city);

  } catch (error) {
    console.error(error);
    alert("ë‚ ì”¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}


// ---------------------------
// â­ 3ì¼ ì˜ˆë³´ â€” ì´ê²ƒë„ Netlify Functionìœ¼ë¡œ í˜¸ì¶œ
// ---------------------------
async function fetchForecast(city) {
  const url = `/.netlify/functions/weather?city=${city}&forecast=1`;

  try {
    const res = await fetch(url);
    const data = await res.json();

    if (data.cod == "404") return;

    // 3ì¼ì¹˜ ë‚ ì”¨ ì¶”ë¦¬ê¸°
    const selected = data.list.filter((item, index) => index % 8 === 0).slice(0, 3);

    const simplified = selected.map(item => ({
      day: new Date(item.dt * 1000).toLocaleDateString("ko-KR", { weekday: "short" }),
      temp: item.main.temp,
      icon: item.weather[0].icon,
    }));

    displayForecast(simplified);

  } catch (error) {
    console.error(error);
    alert("ì˜ˆë³´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  }
}


// --- í˜„ì¬ ë‚ ì”¨ í™”ë©´ ì—…ë°ì´íŠ¸ ---
function displayWeather(data) {
  document.getElementById("temp").textContent = data.main.temp + "Â°C";
  document.getElementById("desc").textContent = data.weather[0].description;
  document.getElementById("humidity").textContent = data.main.humidity;
  document.getElementById("wind").textContent = data.wind.speed;

  document.getElementById("weatherIcon").src =
    `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
}


// --- ì˜¨ë„ë³„ ìºë¦­í„° ì´ë¯¸ì§€ ---
function updateWeatherimage(temp) {
  const img = document.getElementById("weather-image");
  const comment = document.getElementById("weather");

  if (temp >= 30) {
    img.src = "images/hot.png";
    comment.textContent = "ë‚ ì”¨ê°€ ë”ìš°ë‹ˆ ì¡°ì‹¬í•˜ì„¸ìš”!";
  } else if (temp >= 20) {
    img.src = "images/warm.png";
    comment.textContent = "ë”°ëœ»í•œ ë‚ ì”¨ë„¤ìš”!";
  } else if (temp >= 10) {
    img.src = "images/cool.png";
    comment.textContent = "ì„ ì„ í•œ ë‚ ì”¨ì—ìš”!";
  } else {
    img.src = "images/cold.png";
    comment.textContent = "ë‚ ì”¨ê°€ ì¶¥ë„¤ìš”! ì˜· ë”°ëœ»í•˜ê²Œ ì…ìœ¼ì„¸ìš”!";
  }
}


// --- 3ì¼ ì˜ˆë³´ ì¹´ë“œ ---
function displayForecast(list) {
  const container = document.getElementById("forecastContainer");
  container.innerHTML = "";

  list.forEach(item => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <p>${item.day}</p>
      <img src="https://openweathermap.org/img/wn/${item.icon}.png">
      <p>${item.temp}Â°C</p>
    `;

    container.appendChild(card);
  });
}


// --- ê²€ìƒ‰ ë²„íŠ¼ ---
document.getElementById("searchBtn").addEventListener("click", () => {
  const city = document.getElementById("cityInput").value.trim();

  if (city === "") {
    alert("ë„ì‹œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    return;
  }

  fetchWeather(city);
  fetchForecast(city);
});
